build-android-all:
  name: Android All Architectures
  runs-on: ubuntu-24.04
  strategy:
    matrix:
      architecture: [arm64-v8a, armeabi-v7a, x86, x86_64]
  steps:
    - name: Git checkout
      uses: actions/checkout@v4
      with:
        submodules: 'true'
    
    - name: Setup Android NDK
      uses: android-actions/setup-android@v3
    
    - name: Download NDK
      run: |
        wget -q https://dl.google.com/android/repository/android-ndk-r26b-linux.zip
        unzip -q android-ndk-r26b-linux.zip
        echo "ANDROID_NDK_HOME=$PWD/android-ndk-r26b" >> $GITHUB_ENV
        echo "$PWD/android-ndk-r26b" >> $GITHUB_PATH
    
    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v1
      with:
        cmake-version: '3.28.3'
    
    - name: Configure CMake for Android ${{ matrix.architecture }}
      run: |
        mkdir -p build_android_${{ matrix.architecture }}
        cd build_android_${{ matrix.architecture }}
        
        # 设置架构特定的参数
        case ${{ matrix.architecture }} in
          "arm64-v8a")
            ABI="arm64-v8a"
            API=21
            ISA_FLAGS="-DASTCENC_ISA_NEON=ON -DASTCENC_ISA_NONE=ON"
            ;;
          "armeabi-v7a")
            ABI="armeabi-v7a"
            API=16
            ISA_FLAGS="-DASTCENC_ISA_NEON=ON -DASTCENC_ISA_NONE=ON"
            ;;
          "x86")
            ABI="x86"
            API=16
            ISA_FLAGS="-DASTCENC_ISA_SSE2=ON -DASTCENC_ISA_SSE41=ON -DASTCENC_ISA_NONE=ON"
            ;;
          "x86_64")
            ABI="x86_64"
            API=21
            ISA_FLAGS="-DASTCENC_ISA_SSE2=ON -DASTCENC_ISA_SSE41=ON -DASTCENC_ISA_AVX2=ON -DASTCENC_ISA_NONE=ON"
            ;;
        esac
        
        cmake \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=$ABI \
          -DANDROID_PLATFORM=android-$API \
          -DANDROID_STL=c++_static \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=install \
          -DASTCENC_CLI=ON \
          -DASTCENC_SHAREDLIB=OFF \
          $ISA_FLAGS \
          ..
    
    - name: Build Android ${{ matrix.architecture }}
      run: |
        cd build_android_${{ matrix.architecture }}
        make -j4 install
    
    - name: Create archive for ${{ matrix.architecture }}
      run: |
        cd build_android_${{ matrix.architecture }}/install/bin
        tar -czf astcenc-android-${{ matrix.architecture }}.tar.gz astcenc
        sha256sum astcenc-android-${{ matrix.architecture }}.tar.gz > astcenc-android-${{ matrix.architecture }}.tar.gz.sha256
    
    - name: Upload Android ${{ matrix.architecture }} binary
      uses: actions/upload-artifact@v4
      with:
        name: astcenc-android-${{ matrix.architecture }}
        path: |
          build_android_${{ matrix.architecture }}/install/bin/astcenc-android-${{ matrix.architecture }}.tar.gz
          build_android_${{ matrix.architecture }}/install/bin/astcenc-android-${{ matrix.architecture }}.tar.gz.sha256
