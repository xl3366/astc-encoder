name: Build Android

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main

jobs:
  build-android:
    name: Android ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64
            abi: arm64-v8a
            neon: ON      # 64位 ARM 支持完整的 NEON 指令
          - arch: arm32
            abi: armeabi-v7a
            neon: OFF     # 修复：32位 ARM 不支持源码中的 A64 NEON 指令，必须关闭
          - arch: x64
            abi: x86_64
            neon: OFF
          - arch: x86
            abi: x86
            neon: OFF

    steps:
      - name: Git checkout
        uses: actions/checkout@v4
        with:
          submodules: 'true'

      - name: Build
        run: |
          mkdir build_android
          cd build_android
          # 使用系统内置的 NDK 环境
          cmake -G "Unix Makefiles" \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_LATEST_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=${{ matrix.abi }} \
            -DANDROID_PLATFORM=android-24 \
            -DCMAKE_BUILD_TYPE=Release \
            -DASTCENC_ISA_NEON=${{ matrix.neon }} \
            -DASTCENC_ISA_NONE=ON \
            -DASTCENC_UNITTEST=OFF \
            ..
          make -j$(nproc)
          
      - name: Package
        run: |
          cd build_android
          mkdir -p out
          # 寻找编译出的二进制文件并复制
          # astcenc 的产物通常在 Source 目录下
          find Source -maxdepth 1 -type f -executable -name "astcenc-*" -exec cp {} out/ \;
          # 如果有静态库也一并带上
          find Source -maxdepth 1 -name "*.a" -exec cp {} out/ \;
          
          cd out
          zip -r ../astcenc-android-${{ matrix.arch }}.zip ./*

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: astcenc-android-${{ matrix.arch }}
          path: build_android/astcenc-android-${{ matrix.arch }}.zip
