name: Build Android

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main

jobs:
  build-android:
    name: Android ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64
            abi: arm64-v8a
            neon: ON
          - arch: arm32
            abi: armeabi-v7a
            neon: ON
          - arch: x64
            abi: x86_64
            neon: OFF
          - arch: x86
            abi: x86
            neon: OFF

    steps:
      - name: Git checkout
        uses: actions/checkout@v4
        with:
          submodules: 'true'

      - name: Build
        run: |
          mkdir build_android
          cd build_android
          # 使用系统内置的 NDK 最新版本
          cmake -G "Unix Makefiles" \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_LATEST_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=${{ matrix.abi }} \
            -DANDROID_PLATFORM=android-24 \
            -DCMAKE_BUILD_TYPE=Release \
            -DASTCENC_ISA_NEON=${{ matrix.neon }} \
            -DASTCENC_ISA_NONE=ON \
            -DASTCENC_UNITTEST=OFF \
            -DASTCENC_PACKAGE=android-${{ matrix.arch }} \
            ..
          # 先构建，确保错误能清晰抛出
          make -j$(nproc)
          
      - name: Package
        run: |
          cd build_android
          # 创建一个输出目录专门存放要上传的文件
          mkdir -p out
          # 寻找所有的可执行文件 (astcenc-*) 和库文件
          find Source -maxdepth 1 -type f -executable -name "astcenc-*" -exec cp {} out/ \;
          find Source -maxdepth 1 -name "*.a" -exec cp {} out/ \;
          # 打包成 zip (模仿你原有的 release 流程)
          cd out
          zip -r ../astcenc-android-${{ matrix.arch }}.zip ./*

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: astcenc-android-${{ matrix.arch }}
          path: build_android/astcenc-android-${{ matrix.arch }}.zip
