name: Build Android

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main

jobs:
  build-android:
    name: Android ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64-v8a
            abi: arm64-v8a
            neon: ON
          - arch: armv7-a
            abi: armeabi-v7a
            neon: ON
          - arch: x86_64
            abi: x86_64
            neon: OFF
          - arch: x86
            abi: x86
            neon: OFF

    steps:
      - name: Git checkout
        uses: actions/checkout@v4
        with:
          submodules: 'true'

      - name: Setup Android NDK
        id: setup-ndk
        uses: nndixon/setup-android-ndk@v1
        with:
          ndk-version: r26b # 推荐使用较新的 LTS 版本

      - name: Build
        run: |
          mkdir build_android
          cd build_android
          # 使用 NDK 自带的 CMake 工具链文件进行交叉编译
          cmake -G "Unix Makefiles" \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=${{ matrix.abi }} \
            -DANDROID_PLATFORM=android-24 \
            -DANDROID_STL=c++_static \
            -DCMAKE_BUILD_TYPE=Release \
            -DASTCENC_ISA_NEON=${{ matrix.neon }} \
            -DASTCENC_ISA_NONE=ON \
            -DASTCENC_UNITTEST=OFF \
            ..
          make -j$(nproc)

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: astcenc-android-${{ matrix.arch }}
          path: |
            build_android/astcenc*
            build_android/*.so
            build_android/*.a
